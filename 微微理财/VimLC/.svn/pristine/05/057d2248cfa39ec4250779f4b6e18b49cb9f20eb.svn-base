//
//  MSUTradeDetailView.m
//  VimLC
//
//  Created by 007 on 2018/1/15.
//  Copyright © 2018年 HM. All rights reserved.
//

#import "MSUTradeDetailView.h"

#import "MSUProgramDetailView.h"

#import "MSUTradePlanTableCell.h"
#import "MSUTradeRecordTableCell.h"

#import "MSUStringTools.h"
#import "MSUPathTools.h"

@interface MSUTradeDetailView()<UITableViewDelegate,UITableViewDataSource,DZNEmptyDataSetSource,DZNEmptyDataSetDelegate>

@property (nonatomic , strong) MSUProgramDetailView *programView;
@property (nonatomic,strong) UITableView *planTableView;
@property (nonatomic,strong) UITableView *recordTableView;


@end

@implementation MSUTradeDetailView

- (instancetype)initWithFrame:(CGRect)frame
{
    if (self = [super initWithFrame:frame]) {

        self.btnArr = [NSMutableArray array];
        [self createView];
        
    }
    return self;
}


- (void)createView{
    UIView *bgView = [[UIView alloc] init];
    bgView.frame = CGRectMake(0, 0, kDeviceWidth, 47*kDeviceHeightScale);
    bgView.backgroundColor = HEXCOLOR(0xe4e4e4);
    [self addSubview:bgView];
    
    NSArray *arr = @[@"项目详情",@"还款计划",@"投标记录"];
    for (NSInteger i = 0; i < 3; i++) {
        UIButton *btn = [UIButton buttonWithType:UIButtonTypeCustom];
        btn.frame = CGRectMake(34.5*kDeviceWidthScale+(60+61)*kDeviceWidthScale*i, 13*kDeviceHeightScale, 60*kDeviceWidthScale, 20*kDeviceHeightScale);
        [btn setTitle:arr[i] forState:UIControlStateNormal];
        [btn setTitleColor:HEXCOLOR(0x4a4a4a) forState:UIControlStateNormal];
        [btn setTitleColor:titOrangeColor forState:UIControlStateSelected];
        btn.titleLabel.font = [UIFont systemFontOfSize:14];
        [self addSubview:btn];
        [btn addTarget:self action:@selector(iconBtnClick:) forControlEvents:UIControlEventTouchUpInside];
        [self.btnArr addObject:btn];
        
        if (i == 0) {
            btn.selected = YES;
        }
    }
    
    self.lineView = [[UIView alloc] init];
    _lineView.frame = CGRectMake(34.5*kDeviceWidthScale, 44.5*kDeviceHeightScale, 60*kDeviceWidthScale, 1.5);
    _lineView.backgroundColor =titOrangeColor;
    [bgView addSubview:_lineView];
    
    self.programView.hidden = NO;
    self.planTableView.hidden = YES;
    self.recordTableView.hidden = YES;
    
}

#pragma mark - 更新数据
- (void)setDataArr:(NSArray *)dataArr{
    _dataArr = dataArr;

    _programView.dataArr = _dataArr;
}

- (void)setDateArr:(NSArray *)dateArr{
    _dateArr = dateArr;
    
    _programView.dateArr = _dateArr;
}

- (void)setImaArr:(NSArray *)imaArr{
    _imaArr = imaArr;
    
    _programView.imaArr = _imaArr;
}

- (void)setPlanArr:(NSArray *)planArr{
    _planArr = planArr;
    
    [self.planTableView reloadData];
}

- (void)setRecordArr:(NSArray *)recordArr{
    _recordArr = recordArr;
    
    [self.recordTableView reloadData];
}

#pragma -mark - 代理
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (tableView == _planTableView) {
        return _planArr.count;
    } else if (tableView == _recordTableView){
        return _recordArr.count;
    }
    return 0;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (tableView == _planTableView) {
        MSUTradePlanTableCell *cell = [tableView dequeueReusableCellWithIdentifier:@"MSUTradePlanTableCell"];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        if (_planArr.count >= indexPath.row) {
            NSDictionary *dic = _planArr[indexPath.row];
            cell.qiLab.text = [NSString stringWithFormat:@"%ld期",indexPath.row+1];
            cell.timeLab.text = [dic objectForKey:@"expireDate"];
            cell.moneyLab.text = [dic objectForKey:@"repaySumAmount"];
        }
    
        return cell;
    } else if (tableView == _recordTableView){
        MSUTradeRecordTableCell *cell = [tableView dequeueReusableCellWithIdentifier:@"MSUTradeRecordTableCell"];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        NSDictionary *dic = _recordArr[indexPath.row];
        cell.moneyLab.text = [NSString stringWithFormat:@"%@元",[dic objectForKey:@"bidAmount"]];
        cell.nameLab.text = [dic objectForKey:@"usernameMask"];
        NSString *time = [dic objectForKey:@"bidTime"];
        NSString *timestring = [[time componentsSeparatedByString:@"."] objectAtIndex:0];
        NSString  *bidNote =[dic objectForKey:@"bidNote"];
        if (bidNote.length>0) {
            cell.timeLab.text = [NSString stringWithFormat:@"%@ (%@)",timestring,[dic objectForKey:@"bidNote"]];
        }else{
            cell.timeLab.text = [NSString stringWithFormat:@"%@",timestring];
        }
        
//        cell.topImaView.hidden = YES;
//        if (indexPath.row == 0) {
//            cell.topImaView.hidden = NO;
//            cell.topImaView.image = [MSUPathTools showImageWithContentOfFileByName:@"dym_icon"];
//        } else if (indexPath.row == 1){
//            cell.topImaView.hidden = NO;
//            cell.topImaView.image = [MSUPathTools showImageWithContentOfFileByName:@"dem_icon"];
//        } else if (indexPath.row == 2){
//            cell.topImaView.hidden = NO;
//            cell.topImaView.image = [MSUPathTools showImageWithContentOfFileByName:@"dsm_icon"];
//        }
        
        return cell;
    }
    return nil;
}

- (BOOL)emptyDataSetShouldBeForcedToDisplay:(UIScrollView *)scrollView{
    return NO;
}
- (CGFloat)verticalOffsetForEmptyDataSet:(UIScrollView *)scrollView{
    return kDeviceWidth/4+28;
}
-(UIImage *)imageForEmptyDataSet:(UIScrollView *)scrollView
{
    return [UIImage imageNamed:@""];
}
-(NSAttributedString *)titleForEmptyDataSet:(UIScrollView *)scrollView
{
    NSString *text = nil;
    UIFont *font = nil;
    UIColor *textColor = nil;
    NSMutableDictionary *attributes = [NSMutableDictionary new];
    text = @"";
    font = [UIFont systemFontOfSize:13];
    textColor = [UIColor colorWithHex:0x333333];
    
    if (!text) {
        return nil;
    }
    if (font) {
        [attributes setObject:font forKey:NSFontAttributeName];
    }
    if (textColor) {
        [attributes setObject:textColor forKey:NSForegroundColorAttributeName];
    }
    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
}
- (BOOL)emptyDataSetShouldAllowScroll:(UIScrollView *)scrollView{
    return YES;
}
- (BOOL)emptyDataSetShouldAllowTouch:(UIScrollView *)scrollView{
    return  YES;
}
- (void)emptyDataSet:(UIScrollView *)scrollView didTapView:(UIView *)view{
    [self.planTableView.mj_header beginRefreshing];
    [self.recordTableView.mj_header beginRefreshing];

}


#pragma mark - 点击事件
- (void)iconBtnClick:(UIButton *)sender{
    for (UIButton *btn in _btnArr) {
        btn.selected = NO;
    }
    sender.selected = YES;
    
    [UIView animateWithDuration:0.25 animations:^{
        _lineView.center = CGPointMake(sender.center.x, 45*kDeviceHeightScale);
    }];
    
    if (sender == _btnArr[0]) {
        self.programView.hidden = NO;
        self.planTableView.hidden = YES;
        self.recordTableView.hidden = YES;
    } else if (sender == _btnArr[1]){
        self.programView.hidden = YES;
        self.planTableView.hidden = NO;
        self.recordTableView.hidden = YES;
    } else{
        self.programView.hidden = YES;
        self.planTableView.hidden = YES;
        self.recordTableView.hidden = NO;
    }
}

#pragma mark - 初始化
- (MSUProgramDetailView *)programView{
    if (!_programView) {
        _programView = [[MSUProgramDetailView alloc] initWithFrame:CGRectMake(0, 47*kDeviceHeightScale, kDeviceWidth, kDeviceHeight-47*kDeviceHeightScale+200*kDeviceHeightScale)];
        _programView.backgroundColor = WhiteColor;
        [self addSubview:_programView];
    }
    return _programView;
}

- (UITableView *)planTableView{
    if (!_planTableView) {
        _planTableView = [[UITableView alloc] initWithFrame:CGRectMake(0,  47*kDeviceHeightScale, kDeviceWidth, kDeviceHeight- 47*kDeviceHeightScale) style:UITableViewStylePlain];
        _planTableView.backgroundColor = BGWhiteColor;
        _planTableView.scrollEnabled = YES;
        _planTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        _planTableView.showsVerticalScrollIndicator = NO;
        [self addSubview:_planTableView];
        _planTableView.delegate = self;
        _planTableView.dataSource = self;
        _planTableView.emptyDataSetSource = self;
        _planTableView.emptyDataSetDelegate = self;
        _planTableView.panGestureRecognizer.delaysTouchesBegan = _planTableView.delaysContentTouches;
        _planTableView.rowHeight = 59*kDeviceHeightScale;
        [_planTableView registerClass:[MSUTradePlanTableCell class] forCellReuseIdentifier:@"MSUTradePlanTableCell"];
        if (iOS11) {
            _planTableView.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
        }
    }
    return _planTableView;
}

- (UITableView *)recordTableView{
    if (!_recordTableView) {
        _recordTableView = [[UITableView alloc] initWithFrame:CGRectMake(0,  47*kDeviceHeightScale, kDeviceWidth, kDeviceHeight- 47*kDeviceHeightScale) style:UITableViewStylePlain];
        _recordTableView.backgroundColor = BGWhiteColor;
        _recordTableView.scrollEnabled = YES;
        _recordTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        _recordTableView.showsVerticalScrollIndicator = NO;
        [self addSubview:_recordTableView];
        _recordTableView.delegate = self;
        _recordTableView.dataSource = self;
        _recordTableView.emptyDataSetSource = self;
        _recordTableView.emptyDataSetDelegate = self;
        _recordTableView.panGestureRecognizer.delaysTouchesBegan = _planTableView.delaysContentTouches;
        _recordTableView.rowHeight = 59*kDeviceHeightScale;
        [_recordTableView registerClass:[MSUTradeRecordTableCell class] forCellReuseIdentifier:@"MSUTradeRecordTableCell"];
        if (iOS11) {
            _recordTableView.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
        }
    }
    return _recordTableView;
}


@end
