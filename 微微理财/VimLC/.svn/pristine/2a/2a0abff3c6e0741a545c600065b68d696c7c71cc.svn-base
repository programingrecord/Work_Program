//
//  MangerViewController.m
//  WTJR
//
//  Created by H on 16/6/9.
//  Copyright © 2016年 HM. All rights reserved.
//

#import "MangerViewController.h"
#import "CenterItem.h"
#import "PasswordModifyVC.h"
#import "GesturePasswordController.h"
#import "RealViewController.h"
#import "LockNameViewController.h"
#import "RealViewController.h"
#import "AboutViewController.h"
#import "ManagerTableViewCell.h"

@interface MangerViewController ()<UIAlertViewDelegate,UITableViewDelegate,UITableViewDataSource>

@property (strong, nonatomic) UITableView *MangerViewTableview;
@property (nonatomic,strong)GesturePasswordController *gesturePassWord;
@property (nonatomic,strong)NSArray *leftTitleArr;
@property (nonatomic,strong)NSArray *rightTitleArr;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *bottomConstant;
@property (weak, nonatomic) IBOutlet UIButton *setOutBtn;

@end

@implementation MangerViewController

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
}
- (void)viewDidLoad {
    [super viewDidLoad];
    self.title = @"帐户管理";
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    
    NSDictionary *userInfoDetial = [userDefaults objectForKey:@"userInfoDetial"];
    
    self.view.backgroundColor = RGBA(245, 245, 245, 1);

    self.leftTitleArr = @[@[@"手机认证"],@[@"修改交易密码",@"修改登录密码",@"手势密码",@"修改手势密码"],@[@"关于微米"]];
    self.rightTitleArr = @[@[[NSString stringWithFormat:@"*** **** %@",[userInfoDetial objectForKey:@"phone"]]],@[@"",@"",@"",@""],@[@""]];
    
    self.MangerViewTableview = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, kDeviceHeight-kTabBarHeight-60) style:UITableViewStyleGrouped];
    self.MangerViewTableview.delegate = self;
    self.MangerViewTableview.dataSource = self;
    self.MangerViewTableview.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.view addSubview:self.MangerViewTableview];
    
    NSNotificationCenter *center = [NSNotificationCenter defaultCenter];
    [center addObserver:self selector:@selector(receiveNotificiation:) name:@"HandPassWordBack" object:nil];
    
    if (iOS11) {
//        self.setOutBtn.height = 50;
        self.bottomConstant.constant = 20;
        [self.view bringSubviewToFront:self.setOutBtn];
    }
}

#pragma mark - 点击事件
- (void)ItemClick:(CenterItem *)sender{
    switch (sender.tag) {
        case 101:
        {
           PasswordModifyVC  *passWordVC = [[PasswordModifyVC alloc] init];
            [self.navigationController pushViewController:passWordVC animated:YES];
            passWordVC.title=@"修改交易密码";
        }
            break;
        case 102:
        {
            PasswordModifyVC *passWordVC = [[PasswordModifyVC alloc] init];
            [self.navigationController pushViewController:passWordVC animated:YES];
            passWordVC.title=@"修改登录密码";
        }
            break;
        case 104:
        {
            AboutViewController *aboutVC = [[AboutViewController alloc] init];
            [self.navigationController pushViewController:aboutVC animated:YES];
        }
            break;
        default:
            break;
    }
}

- (void)switchAction:(UISwitch *)sender{
    UISwitch *switchButton = (UISwitch*)sender;
    if ([switchButton isOn]) {
        NSLog(@"no");
    }else{
        NSLog(@"yes");
    }
    
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    NSDictionary *passWordDic = [userDefaults objectForKey:@"registerData"];
    if (passWordDic == nil&&switchButton.on == YES) {
        UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"请您先登录" message:nil delegate:nil cancelButtonTitle:nil otherButtonTitles:@"确定", nil];
        [alertView show];
        return;
    }else{
        if (switchButton.on == YES) {
            _gesturePassWord = [[GesturePasswordController alloc] init];
            _gesturePassWord.gestureType = GestureSet;
            [[UIApplication sharedApplication].keyWindow addSubview:_gesturePassWord.view];
        }
        else{
            _gesturePassWord = [[GesturePasswordController alloc] init];
            _gesturePassWord.gestureType = GestureDelete;
            [[UIApplication sharedApplication].keyWindow addSubview:_gesturePassWord.view];
        }
    }
}

- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (buttonIndex == 1) {
        LockNameViewController *LockName =[[LockNameViewController alloc] init];
        [self.navigationController pushViewController:LockName animated:YES];
    }
}

- (IBAction)LoginOut:(id)sender {
    [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    
    [[DataRequestServer getDataRequestServerData] request:@"logout.do" parameters:nil result:^(id result) {
        [MBProgressHUD hideHUDForView:self.view animated:YES];
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            [AddHudView addProgressView:self.view message:@"网络错误，请稍后再试"];
        }else{
            MyLog(@"url= %@",result);
        }
    }];
    [CoreArchive removeNSUserDefaults];
    
    AppDelegate *jj = (AppDelegate *)[[UIApplication sharedApplication] delegate];
    [jj loadMainView];
    [jj.mainVC setSelectedIndex:0];
}

#pragma mark - tableView
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return self.leftTitleArr.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    NSArray *arr= [self.leftTitleArr objectAtIndex:section];
    return arr.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    ManagerTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:@"ManagerTableViewCell"];
    if (!cell)
    {
        [tableView registerNib:[UINib nibWithNibName:@"ManagerTableViewCell" bundle:nil] forCellReuseIdentifier:@"ManagerTableViewCell"];
        cell = [tableView dequeueReusableCellWithIdentifier:@"ManagerTableViewCell"];
    }
    
    if (indexPath.section ==0 || (indexPath.section == 1 && indexPath.row ==2)) {
        cell.imageWidth.constant = 10;
        cell.rightImage.hidden = YES;
    }else{
        cell.imageWidth.constant = 30;
        cell.rightImage.hidden = NO;
    }
    
    if (indexPath.row == 0) {
        cell.TopLineview.hidden = NO;
    }else{
        cell.TopLineview.hidden = YES;
    }
    
    if (indexPath.section == 1 && indexPath.row ==2) {
        cell.CellSwitch.hidden = NO;
        NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
        NSDictionary *passWordDic = [userDefaults objectForKey:@"gestureWord"];
        if (passWordDic != nil) {
            cell.CellSwitch.on = YES;
        }else{
            cell.CellSwitch.on = NO;
        }
        [cell.CellSwitch addTarget:self action:@selector(switchAction:) forControlEvents:UIControlEventValueChanged];
    }else{
        cell.CellSwitch.hidden = YES;
    }
    NSArray *TitleArr = [self.leftTitleArr objectAtIndex:indexPath.section];
    cell.leftTitle.text = [TitleArr objectAtIndex:indexPath.row];
    if (indexPath.row == TitleArr.count-1) {
        cell.BottomLineViewLeft.constant = 0;
    }else{
        cell.BottomLineViewLeft.constant = 10;
    }
    NSArray *RightTitleArr = [self.rightTitleArr objectAtIndex:indexPath.section];
    cell.rightTltle.text = [RightTitleArr objectAtIndex:indexPath.row];
    return cell;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return 20;
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 0.000001;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 50;
}

- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] initWithFrame:CGRectZero];
    return V;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, 20)];
    V.backgroundColor = [UIColor clearColor];
    return V;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 1) {
        switch (indexPath.row) {
            case 0:
            {
                PasswordModifyVC  *passWordVC = [[PasswordModifyVC alloc] init];
                [self.navigationController pushViewController:passWordVC animated:YES];
                passWordVC.title=@"修改交易密码";
            }
                break;
            case 1:
            {
                PasswordModifyVC *passWordVC = [[PasswordModifyVC alloc] init];
                [self.navigationController pushViewController:passWordVC animated:YES];
                passWordVC.title=@"修改登录密码";
            }
                break;
            case 3:{
                NSUserDefaults *defaults= [NSUserDefaults standardUserDefaults];
                NSMutableDictionary *dic= [defaults objectForKey:@"gestureWord"];
                
                NSMutableDictionary *userinfoDic= [defaults objectForKey:@"userInfoDetial"];
                NSMutableDictionary *registerDic= [defaults objectForKey:@"registerData"];
                
                if (userinfoDic && registerDic && [dic objectForKey:@"previousString"]) {
                    _gesturePassWord = [[GesturePasswordController alloc] init];
                    _gesturePassWord.gestureType = GestureReSet;
                    [[UIApplication sharedApplication].keyWindow addSubview:_gesturePassWord.view];
                }else{
                    [AddHudView addProgressView:self.view message:@"手势密码未开启"];
                }
            }
                break;
            default:
                break;
        }
    }else if (indexPath.section == 2){
        AboutViewController *aboutVC = [[AboutViewController alloc] init];
        [self.navigationController pushViewController:aboutVC animated:YES];
    }
}

- (void)receiveNotificiation:(NSNotification*)sender{
    dispatch_async(dispatch_get_main_queue(), ^{
        [self.MangerViewTableview reloadData];
    });
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

- (void)dealloc {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
