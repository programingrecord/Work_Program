//
//  HomeViewController.m
//  VimLC
//
//  Created by 慧明 on 2017/12/26.
//  Copyright © 2017年 HM. All rights reserved.
//

#import "HomeViewController.h"
#import "CustomButton.h"
#import "HomeNewTableViewCell.h"
#import "TradeDetailViewController.h"
#import "PocketDetailNewViewController.h"
#import "LoginViewController.h"
#import "WebViewController.h"
#import "HomeBottomView.h"

@interface HomeViewController ()<UITableViewDelegate,UITableViewDataSource,SDCycleScrollViewDelegate>

@property (weak, nonatomic) IBOutlet UITableView *TableView;
@property (nonatomic,strong) SDCycleScrollView *BannerView;
@property (nonatomic,strong) NSMutableArray *BorrowArr;
@property (nonatomic,strong) UIView *NewWhiteView;
@property (nonatomic,strong) UIView *ButtonWhiteView;
@property (nonatomic,strong) UIView *headView;
@property (nonatomic,strong) NSMutableArray *ImagesArr;
@property (nonatomic,strong) NSMutableArray *PicAddressArr;
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *BottomSpace;

@end

@implementation HomeViewController

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    self.navigationController.navigationBar.translucent = NO;
    [self.navigationController setNavigationBarHidden:YES animated:NO];
    self.tabBarController.tabBar.hidden = NO;
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    if (IS_IPHONE_5) {
        self.BottomSpace.constant = 49;
    }else{
        self.BottomSpace.constant = 0;
    }
    self.automaticallyAdjustsScrollViewInsets = NO;
    self.BorrowArr = [[NSMutableArray alloc] init];
    [ self requestBannerData:NO];
    self.TableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        [self requestBannerData:YES];
    }];
    self.TableView.tableHeaderView = [self addViews];
    self.TableView.tableFooterView = [self addfootViews];

}
- (UIView *)addViews{
    
    self.headView= [[UIView alloc] init];
    self.headView.frame = CGRectMake(0, 0, kDeviceWidth, kDeviceHeightScale*+265);
    self.BannerView = [SDCycleScrollView cycleScrollViewWithFrame:CGRectMake(0, 0,kDeviceWidth,kDeviceHeightScale *170) delegate:self placeholderImage:[UIImage imageNamed:@"placeholder"]];
    self.BannerView.autoScrollTimeInterval = 5.0;
    self.BannerView.localizationImageNamesGroup = @[@"placeholder"];
    self.BannerView.pageControlAliment = SDCycleScrollViewPageContolAlimentCenter;
    [self.headView addSubview:self.BannerView];
    
    self.NewWhiteView = [[UIView alloc] initWithFrame:CGRectMake(0, self.BannerView.bottom,kDeviceWidth, 82*kDeviceHeightScale)];
    self.NewWhiteView.backgroundColor = [UIColor whiteColor];
    self.NewWhiteView.layer.cornerRadius=4;
    self.NewWhiteView.hidden = NO;
    
    
    
    UILabel *TitleLable = [[UILabel alloc] initWithFrame:CGRectMake(37,15*kDeviceHeightScale,self.NewWhiteView.width-37, 28*kDeviceHeightScale)];
    TitleLable.textColor = [UIColor colorWithHex:0x222222];
    TitleLable.font = [UIFont fontWithName:@"PingFangSC-Semibold" size:20];
    [self.NewWhiteView addSubview:TitleLable];
    
    NSString *rateString =@"新手专享福利";
    NSRange range1= [rateString rangeOfString:@"新手"];
    NSMutableAttributedString *Astring1 = [[NSMutableAttributedString alloc] initWithString:rateString];
    [Astring1 addAttribute:NSForegroundColorAttributeName value:[UIColor colorWithHex:0x222222] range:NSMakeRange(0, rateString.length)];
    [Astring1 addAttribute:NSForegroundColorAttributeName value:[UIColor colorWithHex:0xFF6339] range:NSMakeRange(0, range1.length)];
    TitleLable.attributedText =Astring1;
    
    
    UILabel *TitleValueLable = [[UILabel alloc] initWithFrame:CGRectMake(37,TitleLable.bottom+4*kDeviceHeightScale,self.NewWhiteView.width-37, 20*kDeviceHeightScale)];
    TitleValueLable.textColor = [UIColor colorWithHex:0xB0B0B0];
    TitleValueLable.text =@"666元现金红包＋12%高收益＋3％加息";
    TitleValueLable.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
    [self.NewWhiteView addSubview:TitleValueLable];
    
    
    [self.headView addSubview:self.NewWhiteView];
    
    self.ButtonWhiteView = [[UIView alloc] initWithFrame:CGRectMake(0, self.BannerView.bottom, kDeviceWidth, 82*kDeviceHeightScale)];
    self.ButtonWhiteView.backgroundColor = [UIColor whiteColor];
    self.ButtonWhiteView.layer.cornerRadius=4;
    [self.headView addSubview:self.ButtonWhiteView];
    self.ButtonWhiteView.hidden = YES;
    
    NSArray *titelArr = @[@"领福利",@"邀请有奖",@"安全保障"];
    NSArray *imageArr = @[@"home_icon1",@"home_icon2",@"home_icon3"];
    for (int i = 0; i<titelArr.count; i++) {
        CustomButton *Button = [CustomButton buttonWithType:UIButtonTypeCustom];
        Button.frame = CGRectMake(self.ButtonWhiteView.width/3 *i,0,self.ButtonWhiteView.width/3, kDeviceHeightScale*82);
        Button.tag = i;
        Button.backgroundColor = [UIColor whiteColor];
        [Button setTitle:titelArr[i] forState:UIControlStateNormal];
        [Button setImage:[UIImage imageNamed:imageArr[i]] forState:UIControlStateNormal];
        [Button setImage:[UIImage imageNamed:imageArr[i]] forState:UIControlStateHighlighted];
        [Button setTitleColor:[UIColor colorWithHex:0x222222] forState:UIControlStateNormal];
        Button.titleLabel.font = TEXTFONT(13);
        [Button addTarget:self action:@selector(ButtonClick:) forControlEvents:UIControlEventTouchUpInside];
        [self.ButtonWhiteView addSubview:Button];
    }

    
    
    return self.headView;
}
- (UIView *)addfootViews{
    UIScrollView *View = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 10, kDeviceWidth, 55)];
    View.showsHorizontalScrollIndicator = NO;
    View.backgroundColor = [UIColor clearColor];
    
    NSArray *title = @[@"中国人保财险\n承保",@"icp增值业务\n许可证",@"华兴银行资金\n存管",@"融磊资本\n千万级风投"];
    NSArray *images = @[@"iv_home_tips1",@"iv_home_tips2",@"iv_home_tips3",@"iv_home_tips4"];
    for (int i= 0; i<title.count; i++) {
        HomeBottomView *BottomView = [[HomeBottomView alloc] initWithFrame:CGRectMake(i*110,0, 110,55) imageNamed:images[i] title:title[i] titleValue:nil];
        BottomView.backgroundColor =[UIColor clearColor];
        [View addSubview:BottomView];
    }
    View.contentSize = CGSizeMake(110*title.count,0);
    return View;
}
- (NSInteger) tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return 1;
}
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return self.BorrowArr.count;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    
    HomeNewTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"HomeNewTableViewCell"];
    if (!cell) {
        [tableView registerNib:[UINib nibWithNibName:@"HomeNewTableViewCell" bundle:nil] forCellReuseIdentifier:@"HomeNewTableViewCell"];
        cell = [tableView dequeueReusableCellWithIdentifier:@"HomeNewTableViewCell"];
    }
    loanModel *model = [self.BorrowArr objectAtIndex:indexPath.section];
    cell.model = model;
    
    __weak typeof(self) weakSelf=  self;
    cell.block = ^{
        if (![model.borrowTypeOther isEqualToString:@"米粒宝"]){
            TradeDetailViewController *DetailVC = [[TradeDetailViewController alloc] init];
            DetailVC.Loanmodel = model;
            DetailVC.TradeinfoType =TradeinfoTypeloanInfo;
            DetailVC.hidesBottomBarWhenPushed = YES;
            [weakSelf.navigationController pushViewController:DetailVC animated:YES];
        }else{
            PocketDetailNewViewController *VC = [[PocketDetailNewViewController alloc] init];
            VC.hidesBottomBarWhenPushed = YES;
            [weakSelf.navigationController pushViewController:VC animated:YES];
        }
    };
    return cell;
}
- (CGFloat) tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 300;
}
- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *view = [[UIView alloc] initWithFrame:CGRectZero];
    return view;
}
- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *view = [[UIView alloc] initWithFrame:CGRectZero];
    return view;
}
- (CGFloat) tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
- (CGFloat) tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
- (BOOL)emptyDataSetShouldBeForcedToDisplay:(UIScrollView *)scrollView{
    return NO;
}
- (CGFloat)verticalOffsetForEmptyDataSet:(UIScrollView *)scrollView{
    return kDeviceWidth/4+28;
}
-(UIImage *)imageForEmptyDataSet:(UIScrollView *)scrollView
{
    return [UIImage imageNamed:@""];
}
-(NSAttributedString *)titleForEmptyDataSet:(UIScrollView *)scrollView
{
    NSString *text = nil;
    UIFont *font = nil;
    UIColor *textColor = nil;
    NSMutableDictionary *attributes = [NSMutableDictionary new];
    text = @"";
    font = [UIFont systemFontOfSize:13];
    textColor = [UIColor colorWithHex:0x333333];
    
    if (!text) {
        return nil;
    }
    if (font) {
        [attributes setObject:font forKey:NSFontAttributeName];
    }
    if (textColor) {
        [attributes setObject:textColor forKey:NSForegroundColorAttributeName];
    }
    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
}
- (BOOL)emptyDataSetShouldAllowScroll:(UIScrollView *)scrollView{
    return YES;
}
- (BOOL)emptyDataSetShouldAllowTouch:(UIScrollView *)scrollView{
    return  YES;
}
- (void)emptyDataSet:(UIScrollView *)scrollView didTapView:(UIView *)view{
    [self.TableView.mj_header beginRefreshing];
}

#pragma mark - 获取数据
- (void)requestBannerData:(BOOL)isrefresh{
    
    self.ImagesArr = [[NSMutableArray alloc] init];
    self.PicAddressArr = [[NSMutableArray alloc] init];
    if (!isrefresh) {
        [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    }
    
    [[DataRequestServer getDataRequestServerData] request:@"LunaP2pAppBannerHdServlet" parameters:nil result:^(id result) {
        if (isrefresh) {
            [self.TableView.mj_header endRefreshing];
        }else{
            [MBProgressHUD hideHUDForView:self.view animated:YES];
            
        }
        
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            [AddHudView addProgressView:self.view message:@"网络错误，请稍后再试"];
        }else{
            NSArray *array = [[NSArray alloc] initWithArray:result[@"items"]];
            
            for (int i =0; i<array.count; i++) {
                NSDictionary *dict = [array objectAtIndex:i];
                NSArray *strarray = [[dict objectForKey:@"imagesUrl"] componentsSeparatedByString:@"?"];
                [self.ImagesArr addObject:strarray[0]];
                [self.PicAddressArr addObject:[dict objectForKey:@"address"]];
            }
            self.BannerView.imageURLStringsGroup = self.ImagesArr;
            
            
            NSMutableString *AllAmount = [NSMutableString new];
            NSString *AllAmountW = [NSString stringWithFormat:@"%@",[result objectForKey:@"systemAllAmountW"]];
            NSString *AllAmountY = [NSString stringWithFormat:@"%@",[result objectForKey:@"systemAllAmountY"]];
            
            if ([AllAmountW integerValue] >0) {
                [AllAmount appendString:[NSString stringWithFormat:@"%@万",AllAmountW]];
            }
            if ([AllAmountY integerValue] >0) {
                [AllAmount appendString:[NSString stringWithFormat:@"%@元",AllAmountY]];
            }
            
            NSMutableString *AllProfit =[NSMutableString new];
            
            NSString *AllProfitW = [NSString stringWithFormat:@"%@",[result objectForKey:@"systemAllProfitW"]];
            NSString *AllProfitY = [NSString stringWithFormat:@"%@",[result objectForKey:@"systemAllProfitY"]];
            
            if ([AllProfitW integerValue] >0) {
                [AllProfit appendString:[NSString stringWithFormat:@"%@万",AllProfitW]];
            }
            if ([AllProfitY integerValue] >0) {
                [AllProfit appendString:[NSString stringWithFormat:@"%@元",AllProfitY]];
            }
            if (self.BorrowArr.count >0) {
                [self.BorrowArr removeAllObjects];
            }
            NSArray *borrowArray = [[NSArray alloc] initWithArray:result[@"borrowItems"]];
            
            for (NSDictionary *dic in borrowArray) {
                loanModel *model = [[loanModel alloc] initWithContent:dic];
                [self.BorrowArr addObject:model];
                if ([model.borrowTypeOther isEqualToString:@"新手标"]) {
                    self.ButtonWhiteView.hidden = YES;
                    self.NewWhiteView.hidden = NO;
                }else{
                    self.ButtonWhiteView.hidden = NO;
                    self.NewWhiteView.hidden = YES;
                }
            }
            
            [self.TableView reloadData];
        }
    }];
    
}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}
- (void)viewWillDisappear:(BOOL)animated{
    [self.navigationController setNavigationBarHidden:NO animated:NO];
}



- (NSMutableAttributedString *)setAttriButedString:(NSString *)string  searchString1:(NSString *)searchString1 searchString2:(NSString *)searchString2{
    NSRange range = NSMakeRange(0,string.length);
    
    NSMutableAttributedString *Astring = [[NSMutableAttributedString alloc] initWithString:string];
    [Astring addAttribute:NSFontAttributeName value:TEXTFONT(24)  range:range];
    
    NSRange range1= [string rangeOfString:searchString1];
    if (range1.location !=NSNotFound) {
        [Astring addAttribute:NSFontAttributeName value:TEXTFONT(14) range:range1];
    }
    NSRange range2= [string rangeOfString:searchString2];
    if (range1.location !=NSNotFound) {
        [Astring addAttribute:NSFontAttributeName value:TEXTFONT(14) range:range2];
    }
    return Astring;
}


#pragma mark - 交互

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    loanModel *model = [self.BorrowArr objectAtIndex:indexPath.section];
    
    if (![model.borrowTypeOther isEqualToString:@"米粒宝"]){
        TradeDetailViewController *DetailVC = [[TradeDetailViewController alloc] init];
        DetailVC.Loanmodel = model;
        DetailVC.TradeinfoType =TradeinfoTypeloanInfo;
        DetailVC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:DetailVC animated:YES];
        
    }else{
        PocketDetailNewViewController *VC = [[PocketDetailNewViewController alloc] init];
        VC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:VC animated:YES];
    }
}
- (void)ButtonClick:(UIButton *)Sender{
    if (Sender.tag == 0) {
        
        WebViewController *webVC = [[WebViewController alloc] init];
        webVC.UrlString =[ NSString stringWithFormat:@"%@wap/registerActivity3.htm",Base_url];
        webVC.title = @"领福利";
        webVC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:webVC animated:YES];
        
    }else if(Sender.tag == 1){
        NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
        NSDictionary *dic = [defaults objectForKey:@"registerData"];
        if ([dic objectForKey:@"UserName"]&&[dic objectForKey:@"PassWord"] ){
            
            WebViewController *webVC = [[WebViewController alloc] init];
            webVC.UrlString =[ NSString stringWithFormat:@"%@wap/activity/reffer/invitation.htm",Base_url];
            webVC.title = @"邀请好友";
            webVC.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:webVC animated:YES];
        }else{
            LoginViewController *VC= [[LoginViewController alloc] init];
            VC.loginType = logintypePush;
            VC.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:VC animated:YES];
        }
    }else if(Sender.tag == 2){
        WebViewController *webVC = [[WebViewController alloc] init];
        webVC.UrlString =[ NSString stringWithFormat:@"%@wap/content/security.htm",Base_url];
        webVC.title = @"安全保障";
        webVC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:webVC animated:YES];
    }
}

- (void)titleLableTap:(UITapGestureRecognizer *)sendTap{
    //    UITapGestureRecognizer *singleTap = (UITapGestureRecognizer *)sendTap;
    //    NSString *idString = self.TitleidArr[[singleTap view].tag-100];
    //
    //    WebViewController *webVC = [[WebViewController alloc] init];
    //    webVC.UrlString =[ NSString stringWithFormat:@"%@wap/content/announce.htm?aid=%@",Base_url,idString];
    //    webVC.title = @"公告";
    //    [self.navigationController pushViewController:webVC animated:YES];
    
    
}
- (void)cycleScrollView:(SDCycleScrollView *)cycleScrollView didSelectItemAtIndex:(NSInteger)index{
    if (self.PicAddressArr.count>0) {
        WebViewController *webVC = [[WebViewController alloc] init];
        webVC.UrlString =self.PicAddressArr[index];
        webVC.title = @"活动";
        webVC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:webVC animated:YES];
    }
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
