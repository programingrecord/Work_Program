//
//  MSUTradeListController.m
//  VimLC
//
//  Created by 007 on 2018/1/11.
//  Copyright © 2018年 HM. All rights reserved.
//

#import "MSUTradeListController.h"
#import "BuyTradeViewController.h"
#import "MSUPocketDetailController.h"
#import "MSUTradeDetailController.h"
#import "MSUFooterListController.h"

#import "MSUHuoQiTableCell.h"
#import "MSUTradeTableCell.h"
#import "MSUScrollNotiView.h"

#import "MSUPathTools.h"
#import "MSUStringTools.h"


@interface MSUTradeListController ()<UITableViewDelegate,UITableViewDataSource,DZNEmptyDataSetSource,DZNEmptyDataSetDelegate>

@property (nonatomic,strong) UITableView    *TableListView;
@property (nonatomic,assign) NSInteger      currentIndex;
@property (nonatomic,strong) NSMutableArray *currentArr;
@property (nonatomic,strong) NSMutableArray *NewBorrowArr;
@property (nonatomic , strong) NSMutableArray *completeArr;

@property (nonatomic , copy) NSString *mujiCount;
@property (nonatomic , copy) NSString *payCount;
@property (nonatomic , strong) MSUScrollNotiView *notiView;
@property (nonatomic , strong) NSArray *notiArr;


@end

@implementation MSUTradeListController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.title = @"投资";
    self.view.backgroundColor = HEXCOLOR(0xe8e8e8);
    
    if (self.TradeType == MSUTradeListTypeHome) {
        for (UIBarButtonItem *items in self.navigationItem.leftBarButtonItems) {
            items.customView.hidden = YES;
        }
    }else{
        for (UIBarButtonItem *items in self.navigationItem.leftBarButtonItems) {
            items.customView.hidden = NO;
        }
    }
    
    self.currentArr = [[NSMutableArray alloc] init];
    self.NewBorrowArr = [[NSMutableArray alloc] init];
    self.completeArr = [[NSMutableArray alloc] init];
    
    [self addTableView];
    self.currentIndex = 1;
    [self getList:NO withIndex:self.currentIndex ishead:YES];
}

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    self.currentIndex = 1;
    [self getList:YES withIndex:self.currentIndex ishead:YES];
}

- (void)addTableView{
    self.TableListView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0.5, kDeviceWidth, kDeviceHeight-49-64) style:UITableViewStyleGrouped];
    if (is_iPhoneX) {
        self.TableListView.frame = CGRectMake(0, 0, kDeviceWidth, kDeviceHeight-49-64-40);
    }
    self.TableListView.backgroundColor = HEXCOLOR(0xe8e8e8);
    self.TableListView.delegate = self;
    self.TableListView.dataSource = self;
    self.TableListView.separatorStyle = UITableViewCellSeparatorStyleNone;
    _TableListView.showsVerticalScrollIndicator = NO;
    self.TableListView.tableFooterView = [[UIView alloc] initWithFrame:CGRectZero];
    self.TableListView.emptyDataSetSource = self;
    self.TableListView.emptyDataSetDelegate = self;
    [self.view addSubview:self.TableListView];
    if (iOS11) {
        _TableListView.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
    } else{
        self.automaticallyAdjustsScrollViewInsets = NO;
    }
    
    __weak typeof(self) weakSelf= self;
    self.TableListView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        __strong typeof(self) strongSelf= weakSelf;
        strongSelf.currentIndex = 1;
        [strongSelf getList:YES withIndex:strongSelf.currentIndex ishead:YES];
    }];
//    _TableListView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
//        __strong typeof(self) strongSelf= weakSelf;
//        [strongSelf getList:YES withIndex:strongSelf.currentIndex ishead:NO];
//    }];
}

#pragma mark - 请求
-(void)getList:(BOOL )isrefresh withIndex:(NSInteger)index ishead:(BOOL) ishead{
    NSString *url = @"LunaP2pAppBorrowListNewServlet";
    
    if (!isrefresh) {
        [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    }
    NSMutableDictionary *param = [[NSMutableDictionary alloc] init];
    [param setObject:[NSString stringWithFormat:@"%ld",(long)self.currentIndex] forKey:@"index"];
    
    [[DataRequestServer getDataRequestServerData] request:url parameters:param result:^(id result) {
        [MBProgressHUD hideHUDForView:self.view animated:YES];
        
        if (isrefresh) {
            if (ishead) {
                [_TableListView.mj_header endRefreshing];
            }else{
                [_TableListView.mj_footer endRefreshing];
            }
        }
        
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            [PAProgressView showInView:self.view contentString:@"网络错误，请稍后再试"];
            NSDictionary *dic = [[NSUserDefaults standardUserDefaults] objectForKey:@"tradeHistory"];
            if (dic) {
                [self reloadUIWithResultDic:dic ishead:ishead];
            } else{
                NSString *filePath = [[NSBundle mainBundle] pathForResource:@"history" ofType:@"plist"];
                NSMutableArray *data1 = [[NSMutableArray alloc] initWithContentsOfFile:filePath];
                NSDictionary *dic1 = data1[1];
                [self reloadUIWithResultDic:dic1 ishead:YES];
            }

        }else{
            [self reloadUIWithResultDic:result ishead:ishead];
        }
    }];
}

- (void)reloadUIWithResultDic:(NSDictionary *)result ishead:(BOOL)ishead{
    int t = [[result objectForKey:@"success"] intValue];
    NSString *error=[result objectForKey:@"errorlog"];
    
    NSString *pageCount=[result objectForKey:@"pageCount"];
    if (self.currentIndex >= pageCount.integerValue) {
        [self.TableListView.mj_footer endRefreshingWithNoMoreData];
    }else{
        [self.TableListView.mj_footer resetNoMoreData];
    }
    
    self.mujiCount = [NSString stringWithFormat:@"%@",result[@"muJiCount"]];
    self.payCount = [NSString stringWithFormat:@"%@",result[@"payCount"]];
    


    if(t==1 && [error isEqualToString:@""]){
        if (ishead) {
            if (self.currentArr.count>0) {
                [self.currentArr removeAllObjects];
            }
            if (self.NewBorrowArr.count>0) {
                [self.NewBorrowArr removeAllObjects];
            }
            
            if (self.completeArr.count > 0) {
                [self.completeArr removeAllObjects];
            }
        }
        
        NSArray *newarr = [result objectForKey:@"nwBorrowItems"];
        for (NSDictionary *dic in newarr) {
            loanModel *model = [[loanModel alloc] initWithContent:dic];
            [self.NewBorrowArr addObject:model];
        }
//        [self.currentArr addObjectsFromArray:[result objectForKey:@"MainShowArr"]];
        
        for (NSDictionary *dic in [result objectForKey:@"MainShowArr"]) {
            NSString *stateStr = [NSString stringWithFormat:@"%@",dic[@"borrowState"]];
            if ([stateStr containsString:@"招标中"]) {
                [self.currentArr addObject:dic];
            } else if ([stateStr containsString:@"还款中"]){
                [self.completeArr addObject:dic];
            }
        }
        
        [self.TableListView reloadData];
        self.currentIndex++;
        self.notiArr = result[@"scrollArr"];

    }
}

#pragma mark - 代理
- (NSInteger) numberOfSectionsInTableView:(UITableView *)tableView
{
    return 3;
}

- (NSInteger) tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return self.NewBorrowArr.count;
    }else if(section == 1){
        return self.currentArr.count;
    } else{
        return self.completeArr.count;
    }
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    MSUTradeTableCell *cell = [tableView dequeueReusableCellWithIdentifier:@"MSUHomeTableCellA"];
    cell.backgroundColor = HEXCOLOR(0xf3f3f3);
    if (!cell)
    {
        cell = [[MSUTradeTableCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"MSUHomeTableCellA"];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.backgroundColor = [UIColor clearColor];
    }
    cell.bgImageView.hidden = YES;
    
    if (indexPath.section == 0) {
        cell.loanModel = self.NewBorrowArr[0];
    }else if (indexPath.section == 1) {
        if (indexPath.row == _currentArr.count-1) {
            cell.bgView.hidden = YES;
        } else{
            cell.bgView.hidden = NO;
        }
        cell.dataDic = self.currentArr[indexPath.row];
    } else {
        cell.dataDic = self.completeArr[indexPath.row];
    }
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    MSUTradeDetailController *VC = [[MSUTradeDetailController alloc] init];
    NSDictionary *dic = [NSDictionary dictionary];
    if (indexPath.section == 1) {
        dic = _currentArr[indexPath.row];
    } else{
        dic = _completeArr[indexPath.row];
    }
    VC.postDic = dic;
    if (indexPath.section == 0) {
        loanModel *model = self.NewBorrowArr[indexPath.row];
        VC.idStr = [NSString stringWithFormat:@"%@",model.lunaP2pBorrowId];
    }else {
        VC.idStr = [NSString stringWithFormat:@"%@",dic[@"lunaP2pBorrowId"]];
    }
    VC.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:VC animated:YES];
}

- (CGFloat) tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        return 120*kDeviceHeightScale;
    }else{
        if (indexPath.section == 1 && indexPath.row == _currentArr.count-1) {
            return 120*kDeviceHeightScale;
        } else{
            return (120+10)*kDeviceHeightScale;
        }
    }
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] init];

    if (self.currentArr.count > 0) {
        V.backgroundColor = HEXCOLOR(0xe8e8e8);
        
        if (section == 0) {
            V.frame = CGRectMake(0, 0, kDeviceWidth, 34+47);
            
            self.notiView = [[MSUScrollNotiView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, 34) sign:1];
            _notiView.backgroundColor = HEXCOLOR(0xfef3df);
            _notiView.tradeArr = self.notiArr;
            [V addSubview:_notiView];
        } else {
            V.frame = CGRectMake(0, 0, kDeviceWidth, 47);
        }
        
        UIView *bgView = [[UIView alloc] init];
        if (section == 0) {
            bgView.frame = CGRectMake(0, _notiView.bottom, kDeviceWidth, 47);
        } else{
            bgView.frame = CGRectMake(0, 0, kDeviceWidth, 47);
        }
        bgView.backgroundColor = HEXCOLOR(0xf3f3f3);
        [V addSubview:bgView];
        
        NSArray *arr = @[@"新手必选",@"精选理财",@"募集完成"];
        //            NSArray *imaRightArr = @[@"hr",@"dr"];
        //            NSArray *imaLeftArr = @[@"hl",@"dl"];
        
        UILabel *attentionLab = [[UILabel alloc] init];
        attentionLab.text = arr[section];
        CGSize size = [MSUStringTools danamicGetWidthFromText:attentionLab.text WithFont:18];
        attentionLab.font = [UIFont fontWithName:@"PingFangSC-Medium" size:18];
        attentionLab.textAlignment = NSTextAlignmentCenter;
        attentionLab.textColor = HEXCOLOR(0x000000);
        attentionLab.frame = CGRectMake((kDeviceWidth-20*kDeviceWidthScale)*0.5-size.width*0.5, 12*kDeviceHeightScale, size.width, 22.5*kDeviceHeightScale);
        [bgView addSubview:attentionLab];
        
        //            UIImageView *imaRightView = [[UIImageView alloc] initWithFrame:CGRectMake(attentionLab.right+10*kDeviceWidthScale, 17*kDeviceHeightScale, 17*kDeviceWidthScale, 12.2*kDeviceHeightScale)];
        //            imaRightView.image = [MSUPathTools showImageWithContentOfFileByName:imaRightArr[section]];
        //            [V addSubview:imaRightView];
        //
        //            UIImageView *imaLeftView = [[UIImageView alloc] initWithFrame:CGRectMake(attentionLab.left-10*kDeviceWidthScale-17*kDeviceWidthScale, 17*kDeviceHeightScale, 17*kDeviceWidthScale, 12.2*kDeviceHeightScale)];
        //            imaLeftView.image = [MSUPathTools showImageWithContentOfFileByName:imaLeftArr[section]];
        //            [V addSubview:imaLeftView];
        
        UIView *leftView = [[UIView alloc] init];
        leftView.frame = CGRectMake(attentionLab.left-10*kDeviceWidthScale-8*kDeviceHeightScale, 18.5, 8*kDeviceHeightScale, 8*kDeviceHeightScale);
        leftView.backgroundColor = WhiteColor;
        leftView.clipsToBounds = YES;
        leftView.layer.cornerRadius = 4*kDeviceHeightScale;
        leftView.layer.shouldRasterize = YES;
        leftView.layer.rasterizationScale = [UIScreen mainScreen].scale;
        leftView.layer.borderColor = HEXCOLOR(0xFF6339).CGColor;
        leftView.layer.borderWidth = 1;
        [bgView addSubview:leftView];
        
        UIView *rightView = [[UIView alloc] init];
        rightView.frame = CGRectMake(attentionLab.right+10*kDeviceWidthScale, 18.5, 8*kDeviceHeightScale, 8*kDeviceHeightScale);
        rightView.backgroundColor = WhiteColor;
        rightView.clipsToBounds = YES;
        rightView.layer.cornerRadius = 4*kDeviceHeightScale;
        rightView.layer.shouldRasterize = YES;
        rightView.layer.rasterizationScale = [UIScreen mainScreen].scale;
        rightView.layer.borderColor = HEXCOLOR(0xFF6339).CGColor;
        rightView.layer.borderWidth = 1;
        [bgView addSubview:rightView];
        

    }
    return V;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if (self.currentArr.count > 0) {
        if (section == 0) {
            return 34+47;
//            return CGFLOAT_MIN;
        } else{
            return 47;
        }
    }
    return CGFLOAT_MIN;
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 2) {
        return 60*kDeviceHeightScale;
    }
    return CGFLOAT_MIN;
}

- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] initWithFrame:CGRectZero];
    V.backgroundColor = [UIColor clearColor];

    if (section == 2 && self.currentArr.count > 0) {
        V.frame = CGRectMake(0, 0, kDeviceWidth, 60*kDeviceHeightScale);
        
        UIView *bgView = [[UIView alloc] init];
        bgView.frame = CGRectMake(0, 0, kDeviceWidth, 50*kDeviceHeightScale);
        bgView.backgroundColor = HEXCOLOR(0xffffff);
        [V addSubview:bgView];
        
        NSMutableArray *muArr = [NSMutableArray array];
        NSMutableArray *subArr = [NSMutableArray array];;

        if (self.mujiCount.length > 0) {
            [muArr addObject:[NSString stringWithFormat:@"募集完(个): %@",_mujiCount]];
            [subArr addObject:_mujiCount];
        } else{
            [muArr addObject:@"募集完(个): --"];
            [subArr addObject:@"--"];
        }
        
        if (self.payCount.length > 0) {
            [muArr addObject:[NSString stringWithFormat:@"已还款(个): %@",_payCount]];
            [subArr addObject:_payCount];
        } else{
            [muArr addObject:@"已还款(个): --"];
            [subArr addObject:@"--"];
        }
        
        for (NSInteger i = 0; i < 2; i++) {
            UILabel *attentionLab = [[UILabel alloc] init];
            attentionLab.frame = CGRectMake(20+i*kDeviceWidth*0.5, 15*kDeviceHeightScale, (kDeviceWidth-40)*0.5-25-14*kDeviceHeightScale, 20*kDeviceHeightScale);
            attentionLab.font = [UIFont systemFontOfSize:14];
            //        attentionLab.textAlignment = NSTextAlignmentCenter;
            attentionLab.textColor = HEXCOLOR(0xB0B0B0);
            attentionLab.attributedText = [MSUStringTools makeKeyWordAttributedWithSubText:subArr[i] inOrigiText:muArr[i] font:14 color:HEXCOLOR(0xFF7843)];;
            [V addSubview:attentionLab];
            
            UIImageView *imaView = [[UIImageView alloc] initWithFrame:CGRectMake((kDeviceWidth-20)*0.5-20-14*kDeviceHeightScale+i*kDeviceWidth*0.5, 18*kDeviceHeightScale, 14*kDeviceHeightScale, 14*kDeviceHeightScale)];
            imaView.image = [MSUPathTools showImageWithContentOfFileByName:@"icon_arrow_right"];
            imaView.contentMode = UIViewContentModeScaleAspectFit;
            [V addSubview:imaView];
            
            UIButton *btn= [UIButton buttonWithType:UIButtonTypeCustom];
            btn.frame = CGRectMake(i*kDeviceWidth*0.5, 15*kDeviceHeightScale, kDeviceWidth*0.5, 20*kDeviceHeightScale);
            btn.tag = 143+i;
            [V addSubview:btn];
            [btn addTarget:self action:@selector(footerBtnClick:) forControlEvents:UIControlEventTouchUpInside];
        }
        
        UIView *lineView = [[UIView alloc] init];
        lineView.frame = CGRectMake((kDeviceWidth-20)*0.5-0.25, 7.5*kDeviceHeightScale, 0.5, 35*kDeviceHeightScale);
        lineView.backgroundColor = HEXCOLOR(0xDBDBDB);
        [V addSubview:lineView];
    
    } 
    
    return V;
}

- (void)footerBtnClick:(UIButton *)sender{
    MSUFooterListController *list = [[MSUFooterListController alloc] init];
    list.hidesBottomBarWhenPushed = YES;
    if (sender.tag == 143) {
        list.title = @"募集完成";
    } else{
        list.title = @"已还款";
    }
    [self.navigationController pushViewController:list animated:YES];
}


-(UIImage *)imageForEmptyDataSet:(UIScrollView *)scrollView
{
    return [UIImage imageNamed:@"Date_Empty"];
}

-(NSAttributedString *)titleForEmptyDataSet:(UIScrollView *)scrollView
{
    NSString *text = nil;
    UIFont *font = nil;
    UIColor *textColor = nil;
    NSMutableDictionary *attributes = [NSMutableDictionary new];
    
    text = @"暂无数据";
    font = [UIFont systemFontOfSize:13];
    textColor = [UIColor colorWithHex:0x333333];
    
    if (!text) {
        return nil;
    }
    if (font) {
        [attributes setObject:font forKey:NSFontAttributeName];
    }
    if (textColor) {
        [attributes setObject:textColor forKey:NSForegroundColorAttributeName];
    }
    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
}

- (BOOL)emptyDataSetShouldAllowScroll:(UIScrollView *)scrollView{
    return YES;
}

- (BOOL)emptyDataSetShouldAllowTouch:(UIScrollView *)scrollView{
    return  YES;
}

- (void)emptyDataSet:(UIScrollView *)scrollView didTapView:(UIView *)view{
    [self.TableListView.mj_header beginRefreshing];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

- (void)LeftNavigationButtonClick:(UIButton *)leftbtn{
    [self.navigationController popToRootViewControllerAnimated:YES];
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
