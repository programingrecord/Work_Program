//
//  MSUAccountController.m
//  VimLC
//
//  Created by 007 on 2018/3/19.
//  Copyright © 2018年 HM. All rights reserved.
//

#import "MSUAccountController.h"
#import "LoginViewController.h"

#import "MSUTotalView.h"
#import "MSUIncomeView.h"

@interface MSUAccountController ()

@property (nonatomic,strong) NSMutableDictionary *userInfo;
@property (nonatomic , strong) MSUTotalView *totalView;
@property (nonatomic , strong) MSUIncomeView *incomeView;

@property (nonatomic , strong) NSDictionary *dataDic;

@end

@implementation MSUAccountController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.view.backgroundColor = WhiteColor;
    self.title = @"资产详情";
    
    UIView *lineView = [[UIView alloc] init];
    lineView.frame = CGRectMake(0, 0, kDeviceWidth, 1);
    lineView.backgroundColor = LineColor;
    [self.view addSubview:lineView];
    
    NSArray *array = [NSArray arrayWithObjects:@"总资产",@"累计收益", nil];
    //初始化UISegmentedControl
    UISegmentedControl *segment = [[UISegmentedControl alloc]initWithItems:array];
    //设置frame
    segment.frame = CGRectMake(kDeviceWidth*0.5-90, 22, 180, 31);
    segment.tintColor = HEXCOLOR(0xff6339);
    segment.selectedSegmentIndex = 0;
    [segment addTarget:self action:@selector(changeSegment:) forControlEvents:UIControlEventValueChanged];
    //添加到视图
    [self.view addSubview:segment];

    self.totalView.hidden = NO;
 
    
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    NSDictionary *userInfoDetial = [userDefaults objectForKey:@"userInfoDetial"];
    self.userInfo = [userInfoDetial mutableCopy];
    [self requestAccounDetail];
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)requestAccounDetail{
    
    [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    [[DataRequestServer getDataRequestServerData] request:@"LunaP2pAppAmountServlet" parameters:nil result:^(id result) {
        
        [MBProgressHUD hideHUDForView:self.view animated:YES];
        
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            
            [AddHudView addProgressView:self.view message:@"网络错误，请稍后再试"];
        }else{
            int success = [[result objectForKey:@"success"]intValue];
            
            if ([[result objectForKey:@"errorlog"]isEqualToString:@"noLogin"]&& success==0){
                
                [self requestLogin];
            }
            else if([[result objectForKey:@"errorlog"]isEqualToString:@""]&& success==1){
                
                NSArray *arr= [result objectForKey:@"items"];
                self.dataDic = [arr objectAtIndex:0];
                NSString *str = [NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"accountTotalAmount"]];
                self.totalAmount = [[str stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                
                float receipt = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"receiptAmount"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float frozen = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"frozenAmount"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float available = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"availableAmount"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float MLB = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"currentFundAmount"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                
                float january = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"JanuaryMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float seven = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"sevenMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float march = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"MarchMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
                float income = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"IncomeMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];//定期收益

                UILabel *lab = _totalView.muArr[0];
                lab.text = [NSString stringWithFormat:@"%.2f元",january+seven+march+income];
                
                UILabel *lab1 = _totalView.muArr[1];
                lab1.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"sevenMoney"]];
                
                UILabel *lab2 = _totalView.muArr[2];
                lab2.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"JanuaryMoney"]];
                
                UILabel *lab3 = _totalView.muArr[3];
                lab3.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"MarchMoney"]];
                
                UILabel *lab4 = _totalView.muArr[4];
                lab4.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"currentFundAmount"]];
                
                UILabel *lab5 = _totalView.muArr[5];
                lab5.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"availableAmount"]];
                
                UILabel *lab6 = _totalView.muArr[6];
                lab6.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"frozenAmount"]];

                
//                _ReceiptAmount.text = [Dic objectForKey:@"receiptAmount"];
//                _FrozenAmount.text = [Dic objectForKey:@"frozenAmount"];
//                _AvailableAmount.text = [Dic objectForKey:@"availableAmount"];
//                _MLBAmount.text = [Dic objectForKey:@"currentFundAmount"];
                CGFloat totalStr = self.totalAmount +  january+seven+march+income;
                if (_totalAmount !=0) {
//                    [_totalView.proGress setfrozenPersent:frozen/_totalAmount availablePersent:available/_totalAmount receiptPersent:receipt/_totalAmount MLBPersent:MLB/_totalAmount MarchPercent:MLB/_totalAmount totalAccount:self.totalAmount];
                    [_totalView.proGress setfrozenPersent:frozen/_totalAmount availablePersent:available/_totalAmount MLBPersent:MLB/_totalAmount januaryPercent:january/_totalAmount sevenPercent:seven/_totalAmount MarchPercent:march/_totalAmount totalAccount:totalStr totalIncome:self.totalAmount];
                }
            }else{
                [AddHudView addProgressView:self.view message:@"获取数据失败"];
                
            }
        }
    }];
    
    
}
- (void)requestLogin{
    
    [[DataRequestServer getDataRequestServerData] requestLoginresult:^(NSString *LoginState) {
        if ([LoginState isEqualToString:@"true"]) {
            [self requestAccounDetail];
        }else{
            [AddHudView addProgressView:self.view message:@"登录失效，请重新登录"];
            double delayInSeconds = 1.2;
            __block MSUAccountController* BlockVC = self;
            dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC));
            dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                LoginViewController *loginVc= [[LoginViewController alloc] init];
                loginVc.loginType = logintypeOutTime;
                loginVc.hidesBottomBarWhenPushed = YES;
                
                [BlockVC.navigationController pushViewController:loginVc animated:YES];
            });
            
        }
    }];
}

#pragma mark - 点击
-(void)changeSegment:(UISegmentedControl *)sender{
    if (sender.selectedSegmentIndex == 0) {
        self.totalView.hidden = NO;
        self.incomeView.hidden = YES;
    } else {
        self.totalView.hidden = YES;
        self.incomeView.hidden = NO;
        
        UILabel *lab11 = _incomeView.muArr[0];
        lab11.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"IncomeMoney"]];
        
        UILabel *lab22 = _incomeView.muArr[1];
        lab22.text = [NSString stringWithFormat:@"%@元",[_dataDic objectForKey:@"MLBIncomeMoney"]];
        
        
        if (_totalAmount !=0) {
            float mlb = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"MLBIncomeMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];
            float income = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"IncomeMoney"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];//定期收益
            float accumulated = [[[NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"accumulatedincome"]] stringByReplacingOccurrencesOfString:@"," withString:@""] floatValue];//定期收益

            //                    [_totalView.proGress setfrozenPersent:frozen/_totalAmount availablePersent:available/_totalAmount receiptPersent:receipt/_totalAmount MLBPersent:MLB/_totalAmount MarchPercent:MLB/_totalAmount totalAccount:self.totalAmount];
            [_incomeView.proGress setRegIncomePersent:income/accumulated MLBIncomePersent:mlb/accumulated totalIncome:accumulated];
        }
    }
}

#pragma mark - 初始化
- (MSUTotalView *)totalView{
    if (!_totalView) {
        _totalView = [[MSUTotalView alloc] initWithFrame:CGRectMake(0, 80, kDeviceWidth, kDeviceHeight-80)];
        _totalView.backgroundColor = WhiteColor;
        [self.view addSubview:_totalView];
    }
    return _totalView;
}

- (MSUIncomeView *)incomeView{
    if (!_incomeView) {
        _incomeView = [[MSUIncomeView alloc] initWithFrame:CGRectMake(0, 80, kDeviceWidth, kDeviceHeight-80)];
        _incomeView.backgroundColor = WhiteColor;
        [self.view addSubview:_incomeView];
    }
    return _incomeView;
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
