//
//  MSUTradeDetailController.m
//  VimLC
//
//  Created by 007 on 2018/1/11.
//  Copyright © 2018年 HM. All rights reserved.
//

#import "MSUTradeDetailController.h"
#import "BuyTradeViewController.h"
#import "LoginViewController.h"

#import "MSUTradeTopView.h"
#import "MSUTradeBottomView.h"
#import "MSUTradeDetailView.h"


#import "CoreArchive.h"

@interface MSUTradeDetailController ()<UIScrollViewDelegate>

@property (nonatomic , strong) UIScrollView *scrollView;
@property (nonatomic , strong) MSUTradeTopView *topView;
@property (nonatomic , strong) MSUTradeBottomView *bottomView;
@property (nonatomic , strong) MSUTradeDetailView *nextView;
@property (nonatomic , assign) BOOL isScrollDown;

@property (nonatomic , strong) UIButton *touZiBtn;

@property (nonatomic , strong) NSDictionary *dataDic;
@property (nonatomic , strong) UIImageView *adImaView;

@end

@implementation MSUTradeDetailController

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self requestData];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.title = self.Loanmodel.title;
    
    [self createUIView];
}

- (void)createUIView{
    self.scrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, kDeviceHeight)];
    _scrollView.backgroundColor  = [UIColor whiteColor];
    _scrollView.contentSize = CGSizeMake(kDeviceWidth, kDeviceHeight*2);
    _scrollView.scrollEnabled = YES;
    _scrollView.delegate = self;
    _scrollView.showsHorizontalScrollIndicator = NO;
    _scrollView.showsVerticalScrollIndicator = NO;
    self.automaticallyAdjustsScrollViewInsets = NO;
    [self.view addSubview:_scrollView];

    self.topView = [[MSUTradeTopView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, 209.5*kDeviceHeightScale)];
    _topView.backgroundColor = HEXCOLOR(0xff6735);
    [_scrollView addSubview:_topView];
    
    self.adImaView = [[UIImageView alloc] initWithFrame:CGRectMake(0, _topView.bottom+13*kDeviceHeightScale, kDeviceWidth, 71*kDeviceHeightScale)];
//    _adImaView.image = [MSUPathTools showImageWithContentOfFileByName:@""];
    _adImaView.backgroundColor = HEXCOLOR(0xfff5da);
    [_scrollView addSubview:_adImaView];
    
    self.bottomView = [[MSUTradeBottomView alloc] init];
    _bottomView.frame = CGRectMake(0, _adImaView.bottom+13*kDeviceHeightScale, kDeviceWidth, (50.5*4+35)*kDeviceHeightScale);
    _bottomView.backgroundColor = WhiteColor;
    [_scrollView addSubview:_bottomView];
    __weak typeof(self) weakSelf = self;
    _bottomView.moreBtnClickBlock = ^(UIButton *btn) {
        __strong typeof(weakSelf) strongSelf = weakSelf;
        [UIView animateWithDuration:0.25 animations:^{
            [strongSelf.scrollView setContentOffset:CGPointMake(0, strongSelf.nextView.top) animated:NO];
            strongSelf.touZiBtn.hidden = YES;
            strongSelf.nextView.hidden = NO;
        } completion:nil];

    };
    
    self.nextView = [[MSUTradeDetailView alloc] init];
    _nextView.frame = CGRectMake(0, _bottomView.bottom, kDeviceWidth, kDeviceHeight);
    _nextView.backgroundColor = WhiteColor;
    [_scrollView addSubview:_nextView];
    _nextView.hidden = YES;
    
    self.touZiBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    _touZiBtn.frame = CGRectMake(14*kDeviceWidthScale, kDeviceHeight-76-44*kDeviceHeightScale, kDeviceWidth-28*kDeviceHeightScale, 44*kDeviceHeightScale);
    _touZiBtn.backgroundColor = HEXCOLOR(0xfb6337);
    _touZiBtn.layer.cornerRadius = 4;
    _touZiBtn.clipsToBounds = YES;
    _touZiBtn.layer.shouldRasterize = YES;
    _touZiBtn.layer.rasterizationScale = [UIScreen mainScreen].scale;
    [_touZiBtn setTitle:@"立即投标" forState:UIControlStateNormal];
    [_touZiBtn setTitleColor:WhiteColor forState:UIControlStateNormal];
    _touZiBtn.titleLabel.font = [UIFont systemFontOfSize:18];
    [self.view addSubview:_touZiBtn];
    [_touZiBtn addTarget:self action:@selector(touZiBtnClick:) forControlEvents:UIControlEventTouchUpInside];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - 代理
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    static CGFloat lastOffsetY = 0;

    NSLog(@"---- %f  %f ,%d",lastOffsetY,scrollView.contentOffset.y,_isScrollDown);
    _isScrollDown = lastOffsetY < scrollView.contentOffset.y;
    lastOffsetY = scrollView.contentOffset.y;
    
    if (scrollView.contentOffset.y > 10) {
        _touZiBtn.hidden = YES;
        _nextView.hidden = NO;
    }

}

-(void)scrollViewWillBeginDecelerating: (UIScrollView *)scrollView{
    NSLog(@"1");
    if (_isScrollDown && scrollView.contentOffset.y < _nextView.top) {
        [UIView animateWithDuration:0.25 animations:^{
            [scrollView setContentOffset:CGPointMake(0, _nextView.top) animated:NO];
            _nextView.hidden = NO;
        }];

    } else if(_isScrollDown == 0 && scrollView.contentOffset.y < _nextView.top && scrollView.contentOffset.y >10){
        [UIView animateWithDuration:0.25 animations:^{
            [scrollView setContentOffset:CGPointZero animated:NO];
            _nextView.hidden = YES;
        } completion:^(BOOL finished) {
            _touZiBtn.hidden = NO;

        }];
    }
}

#pragma mark - 初始化


#pragma mark - 点击事件
- (void)touZiBtnClick:(UIButton *)sender{
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    NSDictionary *dic = [userDefaults objectForKey:@"registerData"];
    if ([dic objectForKey:@"UserName"] && [dic objectForKey:@"PassWord"]) {
        BuyTradeViewController *BuyVC = [[BuyTradeViewController alloc] init];
        BuyVC.model = self.Loanmodel;
        [self.navigationController pushViewController:BuyVC animated:YES];
    }else{
        [CoreArchive removeNSUserDefaults];
        LoginViewController *loginView = [[LoginViewController alloc] init];
        loginView.loginType = logintypeHome;
        loginView.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:loginView animated:YES];
    }
}

#pragma mark - 请求数据
- (void)requestData{
    
    NSLog(@"lunaP2pBorrowId%@",_Loanmodel.lunaP2pBorrowId);
    NSMutableDictionary *dic= [[NSMutableDictionary alloc] init];
    [dic setObject:_Loanmodel.lunaP2pBorrowId forKey:@"brid"];
//    [dic setObject:@"680" forKey:@"brid"];

    [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    [[DataRequestServer getDataRequestServerData] request:@"LunaP2pAppBorrowServlet" parameters:dic result:^(id result) {
        [MBProgressHUD hideHUDForView:self.view animated:YES];
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            [AddHudView addProgressView:self.view message:@"网络错误，请稍后再试"];
        }else{
            int success = [[result objectForKey:@"success"]intValue];
            
            if ([[result objectForKey:@"errorlog"]isEqualToString:@""]&& success==1)
            {
                NSArray *arr = [result objectForKey:@"items"];
                self.dataDic = [arr objectAtIndex:0];
                [self setUIWithDic:_dataDic];
                
                /// MSU
                _nextView.dataArr = @[result[@"pragramIntro"],result[@"borrowDescribe"]];
                _nextView.dateArr = result[@"dateArr"];
//                NSArray *arr = [dics objectForKey:@"borrowImages"];

                _nextView.planArr = _dataDic[@"repaymentPlans"];
                _nextView.recordArr = _dataDic[@"bids"];
            }
        }
    }];
    
}

- (void)setUIWithDic:(NSDictionary *)dic{
    _topView.priceLab.text = [NSString stringWithFormat:@"%@%@",[dic objectForKey:@"rate"],[dic objectForKey:@"rateIncrease"]];
    _topView.limitLab.text = [NSString stringWithFormat:@"%@",[dic objectForKey:@"timeCount"]];
    _topView.surplusLab.text = [NSString stringWithFormat:@"%@",[_dataDic objectForKey:@"amountLeft"]];
    _topView.totalLab.text = [NSString stringWithFormat:@"%@万",[dic objectForKey:@"amountW"]];
    
    _topView.progressView.progress = [[dic objectForKey:@"completePercent"] floatValue]/100;
    _topView.progressBtn.center = CGPointMake(14*kDeviceWidthScale+_topView.progressView.progress*(kDeviceWidth-28*kDeviceWidthScale),_topView.progressView.top - 17*kDeviceHeightScale);
    [_topView.progressBtn setTitle:[NSString stringWithFormat:@"%ld%%",[[dic objectForKey:@"completePercent"] integerValue]] forState:UIControlStateNormal];
    
    NSArray *arr = @[[dic objectForKey:@"endBidDate"],[dic objectForKey:@"minBidAmount"],[dic objectForKey:@"calculationType"],dic[@"jixiStyle"]];//[dic objectForKey:@"jixiStyle"]
    _bottomView.dataArr = arr;
    
    NSString *str = dic[@"adIma"];
    if (str.length == 0) {
        _adImaView.hidden = YES;
        _bottomView.frame = CGRectMake(0, _topView.bottom+13*kDeviceHeightScale, kDeviceWidth, (50.5*4+35)*kDeviceHeightScale);
        _nextView.frame = CGRectMake(0, _bottomView.bottom, kDeviceWidth, kDeviceHeight);

    } else{
        _adImaView.hidden = NO;
        [_adImaView sd_setImageWithURL:[NSURL URLWithString:dic[@"adIma"]]];
    }
    

}


@end
