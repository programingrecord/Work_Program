//
//  TradeListViewController.m
//  WTJR
//
//  Created by HM on 16/5/30.
//  Copyright © 2016年 HM. All rights reserved.
//

#import "TradeListViewController.h"
//#import "MainTabBarViewController.h"
#import "loanModel.h"
#import "loanCell.h"
#import "TransferCell.h"
#import "CustomButton.h"
#import "TradeDetailViewController.h"
#import "TransferModel.h"
#import "BuyTradeViewController.h"
#import "LoginViewController.h"
#import "PocketDetailViewController.h"
#import "PocketBuyViewController.h"
#import "PocketDetailNewViewController.h"
#import "MLBTableViewCell.h"
#import "NewTableViewCell.h"

#define TOPHEIGHT 40


@interface TradeListViewController ()<UITableViewDelegate,UITableViewDataSource,DZNEmptyDataSetSource,DZNEmptyDataSetDelegate>

@property (nonatomic,strong) UITableView    *TableListView;
@property (nonatomic,strong) NSMutableArray *dataArray;
@property (nonatomic,strong) NSMutableArray *currentArr;

@property (nonatomic,assign) NSInteger      totailIndex;
@property (nonatomic,assign) NSInteger      currentIndex;
@property (nonatomic,strong) NSMutableArray *NewBorrowArr;

@end

@implementation TradeListViewController

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
//    self.tabBarController.tabBar.hidden = NO;
}
- (void)viewDidLoad {

    [super viewDidLoad];
    self.title = @"理财";

//    [self.navigationController.navigationBar setTitleTextAttributes:@{NSForegroundColorAttributeName:[UIColor whiteColor],NSFontAttributeName: [UIFont systemFontOfSize:18]}];
//    
//    [self.navigationController.navigationBar setBarTintColor:[UIColor whiteColor]];
//    [UIApplication sharedApplication].statusBarStyle = UIStatusBarStyleLightContent;

    
    
    if (self.TradeType == TradeListTypeHome) {
        
        for (UIBarButtonItem *items in self.navigationItem.leftBarButtonItems) {
            items.customView.hidden = YES;
        }
    }else{
        for (UIBarButtonItem *items in self.navigationItem.leftBarButtonItems) {
            items.customView.hidden = NO;
        }
    }
    self.dataArray = [[NSMutableArray alloc] init];

    self.currentArr = [[NSMutableArray alloc] init];

    self.NewBorrowArr = [[NSMutableArray alloc] init];
    
    
    [self addTableView];
    self.currentIndex = 1;
    [self getList:NO withIndex:self.currentIndex ishead:YES];
}


#pragma mark - UI加载


- (void)addTableView{
    
    self.TableListView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, kDeviceHeight-kStatusBarHeight-kNavigationBarHeight) style:UITableViewStyleGrouped];
    self.TableListView.backgroundColor = [UIColor colorWithHex:0xEDEDED];
    self.TableListView.delegate = self;
    self.TableListView.dataSource = self;
    self.TableListView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.TableListView.tableFooterView = [[UIView alloc] initWithFrame:CGRectZero];
    self.TableListView.emptyDataSetSource = self;
    self.TableListView.emptyDataSetDelegate = self;
    [self.view addSubview:self.TableListView];

    
    __weak typeof(self) weakSelf= self;
    
    self.TableListView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        __strong typeof(self) strongSelf= weakSelf;

        strongSelf.currentIndex = 1;
        [strongSelf getList:YES withIndex:strongSelf.currentIndex ishead:YES];
    }];
    _TableListView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        __strong typeof(self) strongSelf= weakSelf;
        [strongSelf getList:YES withIndex:strongSelf.currentIndex ishead:NO];
    }];

}


#pragma mark - 请求
-(void)getList:(BOOL )isrefresh withIndex:(NSInteger)index ishead:(BOOL) ishead{
    
    
//    NSString *url = @"LunaP2pAppBorrowListServlet";
    NSString *url = @"LunaP2pAppBorrowListNewServlet";

    if (!isrefresh) {
        [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    }
    NSMutableDictionary *param = [[NSMutableDictionary alloc] init];
    [param setObject:[NSString stringWithFormat:@"%d",self.currentIndex] forKey:@"index"];
    
    [[DataRequestServer getDataRequestServerData] request:url parameters:param result:^(id result) {
       
        [MBProgressHUD hideHUDForView:self.view animated:YES];
        
        
        if (isrefresh) {
            if (ishead) {
                [_TableListView.mj_header endRefreshing];
            }else{
                [_TableListView.mj_footer endRefreshing];
            }
        }
        
        if ([result isKindOfClass:[NSString class]] &&  [result isEqualToString:@"44"]) {
            [AddHudView addProgressView:self.view message:@"网络错误，请稍后再试"];
        }else{
                int t = [[result objectForKey:@"success"] intValue];
                NSString *error=[result objectForKey:@"errorlog"];
                
                NSString *pageCount=[result objectForKey:@"pageCount"];
                if (self.currentIndex >= pageCount.integerValue) {
                    [self.TableListView.mj_footer endRefreshingWithNoMoreData];
                }else{
                    [self.TableListView.mj_footer resetNoMoreData];
                }

                if(t==1 && [error isEqualToString:@""]){
                    if (ishead) {
                        if (self.dataArray.count >0 ) {
                            [self.dataArray removeAllObjects];
                        }
                        if (self.currentArr.count>0) {
                            [self.currentArr removeAllObjects];
                        }
                        if (self.NewBorrowArr.count>0) {
                            [self.NewBorrowArr removeAllObjects];
                        }
                    }
                    
                    
                    NSArray *arr1 = [result objectForKey:@"currentItems"];
                    for (NSDictionary *dic in arr1) {
                        loanModel *model = [[loanModel alloc] initWithContent:dic];
                        [self.currentArr addObject:model];
                    }
                    
                    NSArray *newarr = [result objectForKey:@"nwBorrowItems"];
                    for (NSDictionary *dic in newarr) {
                        loanModel *model = [[loanModel alloc] initWithContent:dic];
                        [self.NewBorrowArr addObject:model];
                    }
                    NSArray *arr = [result objectForKey:@"items"];
                    for (NSDictionary *dic in arr) {
                        loanModel *model = [[loanModel alloc] initWithContent:dic];
                        [self.dataArray addObject:model];
                    }
                    [self.TableListView reloadData];
                    self.currentIndex++;

                }
        }
    }];
}



#pragma mark - 代理

//- (UIView)CreatTableHeadView{
//    
//    return <#expression#>
//}
- (NSInteger) numberOfSectionsInTableView:(UITableView *)tableView
{
    return 3;
}
- (NSInteger) tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return self.currentArr.count;
    }else if (section == 1) {
        return self.NewBorrowArr.count;
    }else{
        return self.dataArray.count;
    }
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        
        MLBTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:@"MLBTableViewCell"];
        if (!cell)
        {
            [tableView registerNib:[UINib nibWithNibName:@"MLBTableViewCell" bundle:nil] forCellReuseIdentifier:@"MLBTableViewCell"];
            cell = [tableView dequeueReusableCellWithIdentifier:@"MLBTableViewCell"];
        }
         loanModel *model = [self.currentArr objectAtIndex:indexPath.row];

        cell.TipLabel.text = model.currentTip3;
        cell.RateLabel.text = [NSString stringWithFormat:@"%@%%",model.rate];
        return cell;
    }else if (indexPath.section == 1) {
        NewTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"NewTableViewCell"];
        if (!cell)
        {
            [tableView registerNib:[UINib nibWithNibName:@"NewTableViewCell" bundle:nil] forCellReuseIdentifier:@"NewTableViewCell"];
            cell = [tableView dequeueReusableCellWithIdentifier:@"NewTableViewCell"];
        }
        cell.TopSpace.constant = 60;
        cell.TypeImageView.hidden = NO;
        cell.LineImageView.hidden = NO;
        cell.viewBottomSpace.constant = 10;
        cell.TypeImageView.image = [UIImage imageNamed:@"new_borrow_icon"];
        
        cell.lineView.hidden = YES;
        cell.model = [self.NewBorrowArr objectAtIndex:indexPath.row];
        cell.block = ^{
            loanModel *models = [self.NewBorrowArr objectAtIndex:indexPath.row];
            BuyTradeViewController *BuyVC = [[BuyTradeViewController alloc] init];
            BuyVC.model = models;
            BuyVC.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:BuyVC animated:YES];
        };
        
        return cell;
    }else{
        
        NewTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"NewTableViewCell"];
        if (!cell)
        {
            [tableView registerNib:[UINib nibWithNibName:@"NewTableViewCell" bundle:nil] forCellReuseIdentifier:@"NewTableViewCell"];
            cell = [tableView dequeueReusableCellWithIdentifier:@"NewTableViewCell"];
        }
        
        cell.viewBottomSpace.constant = 0;
        if (indexPath.row == 0) {
            cell.TopSpace.constant = 60;
            cell.TypeImageView.hidden = NO;
            cell.LineImageView.hidden = NO;
            cell.TypeImageView.image = [UIImage imageNamed:@"old_borrow_icon"];
        }else{
            cell.TopSpace.constant = 12;
            cell.TypeImageView.hidden = YES;
            cell.LineImageView.hidden = YES;
        }
        
        if (indexPath.row == self.dataArray.count-1) {
            cell.lineView.hidden = YES;
        }else{
            cell.lineView.hidden = NO;

        }
        cell.model = [self.dataArray objectAtIndex:indexPath.row];

        cell.block = ^{
            loanModel *models = [self.dataArray objectAtIndex:indexPath.row];
            BuyTradeViewController *BuyVC = [[BuyTradeViewController alloc] init];
            BuyVC.model = models;
            BuyVC.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:BuyVC animated:YES];
        };
        return cell;
    }
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        PocketDetailNewViewController *VC = [[PocketDetailNewViewController alloc] init];
        loanModel *model = (loanModel *)[self.currentArr objectAtIndex:indexPath.row];
        VC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:VC animated:YES];
    }else if (indexPath.section == 1){
        TradeDetailViewController *VC = [[TradeDetailViewController alloc] init];
        loanModel *model = (loanModel *)[self.NewBorrowArr objectAtIndex:indexPath.row];
        VC.Loanmodel = model;
        VC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:VC animated:YES];
    }else{
        TradeDetailViewController *VC = [[TradeDetailViewController alloc] init];
        loanModel *model = (loanModel *)[self.dataArray objectAtIndex:indexPath.row];
        VC.Loanmodel = model;
        VC.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:VC animated:YES];
    }
}



- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] initWithFrame:CGRectZero];
    return V;
}
- (CGFloat) tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        return 132;
    }else if (indexPath.section == 1) {
        return 170;
    }else{
        if (indexPath.row == 0) {
            return 160;
        }else{
            return 110;
        }
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *V= [[UIView alloc] initWithFrame:CGRectZero];
    V.backgroundColor = [UIColor clearColor];
    return V;
}
-(UIImage *)imageForEmptyDataSet:(UIScrollView *)scrollView
{
    return [UIImage imageNamed:@"Date_Empty"];
}
-(NSAttributedString *)titleForEmptyDataSet:(UIScrollView *)scrollView
{
    NSString *text = nil;
    UIFont *font = nil;
    UIColor *textColor = nil;
    NSMutableDictionary *attributes = [NSMutableDictionary new];
    
    text = @"暂无数据，点击重新加载";
    font = [UIFont systemFontOfSize:13];
    textColor = [UIColor colorWithHex:0x333333];
    
    if (!text) {
        return nil;
    }
    if (font) {
        [attributes setObject:font forKey:NSFontAttributeName];
    }
    if (textColor) {
        [attributes setObject:textColor forKey:NSForegroundColorAttributeName];
    }
    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
}
- (BOOL)emptyDataSetShouldAllowScroll:(UIScrollView *)scrollView{
    return YES;
}

- (BOOL)emptyDataSetShouldAllowTouch:(UIScrollView *)scrollView{
    return  YES;
}
- (void)emptyDataSet:(UIScrollView *)scrollView didTapView:(UIView *)view{
    [self.TableListView.mj_header beginRefreshing];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

- (void)LeftNavigationButtonClick:(UIButton *)leftbtn{
    [self.navigationController popToRootViewControllerAnimated:YES];
}

@end
